---
title: "Preprocess your data with recipes"
date: last-modified
date-format: "[Last modified on] MMMM DD, YYYY HH:mm:ss zzz"
format:
  html: 
    axe:
      output: document
  pdf: default
editor: source
---

```{r include = FALSE}
library(knitr) # packages
library(tidyverse)
library(scales)
knitr::opts_chunk$set(echo = TRUE, fig.align = "center", comment = NA, message = FALSE,  warning = FALSE)
```

:::{.callout-important title="Crediting the materials" icon=false}
The majority of the material in this document is taken from [https://www.tidymodels.org/start/models/](https://www.tidymodels.org/start/models/)
:::

## INTRODUCTION

In our _Build a Model_ article, we learned how to specify and train models with different engines using the [parsnip](https://parsnip.tidymodels.org/) package. In this article, we’ll explore another tidymodels package, [recipes](https://recipes.tidymodels.org/), which is designed to help you preprocess your data _before_ training your model. Recipes are built as a series of preprocessing steps, such as:

* converting qualitative predictors to indicator variables (also known as dummy variables),

* transforming data to be on a different scale (e.g., taking the logarithm of a variable),

* transforming whole groups of predictors together,

* extracting key features from raw variables (e.g., getting the day of the week out of a date variable),

and so on. If you are familiar with R’s formula interface, a lot of this might sound familiar and like what a formula already does. Recipes can be used to do many of the same things, but they have a much wider range of possibilities. This article shows how to use recipes for modeling.

To use code in this article, you will need to install the following packages: `nycflights13`, `skimr`, and `tidymodels`.

:::{.callout-note icon=false}
All of the required packages are already **installed** on the mathr server.  However, you will need to **load** the packages using the `library()` function to access the data and functions in each package.
:::

```{r}
library(tidymodels)      # for the recipes package, along with the rest of tidymodels

# Helper packages
library(nycflights13)    # for flight data
library(skimr)           # for variable summaries
```

## THE NEW YORK CITY FLIGHT DATA

Let’s use the [nycflights13](https://github.com/tidyverse/nycflights13) data to predict whether a plane arrives more than 30 minutes late. This data set contains information on 325,819 flights departing near New York City in 2013. Let’s start by loading the data and making a few changes to the variables:

```{r}
set.seed(123)

flight_data <- flights |>  
  mutate(
    # Convert the arrival delay to a factor
    arr_delay = ifelse(arr_delay >= 30, "late", "on_time"),
    arr_delay = factor(arr_delay),
    # We will use the date (not date-time) in the recipe below
    date = lubridate::as_date(time_hour)
  ) |>  
  # Include the weather data
  inner_join(weather, by = c("origin", "time_hour")) |>  
  # Only retain the specific columns we will use
  dplyr::select(dep_time, flight, origin, dest, air_time, distance, 
         carrier, date, arr_delay, time_hour) |>  
  # Exclude missing data
  na.omit() |>  
  # For creating models, it is better to have qualitative columns
  # encoded as factors (instead of character strings)
  mutate_if(is.character, as.factor)
```

We can see that about 16% of the flights in this data set arrived more than 30 minutes late.

```{r}
flight_data |>  
  count(arr_delay) |>  
  mutate(prop = n/sum(n)) |> 
  kable()
```

