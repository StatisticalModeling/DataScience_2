<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Get out the vote</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="VOTERS_files/libs/clipboard/clipboard.min.js"></script>
<script src="VOTERS_files/libs/quarto-html/quarto.js"></script>
<script src="VOTERS_files/libs/quarto-html/popper.min.js"></script>
<script src="VOTERS_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="VOTERS_files/libs/quarto-html/anchor.min.js"></script>
<link href="VOTERS_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="VOTERS_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="VOTERS_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="VOTERS_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="VOTERS_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="VOTERS.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Get out the vote</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Last modified on March 04, 2025 13:45:44 Eastern Standard Time</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="callout callout-style-default callout-note no-icon callout-titled" title="Crediting the materials">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Crediting the materials
</div>
</div>
<div class="callout-body-container callout-body">
<p>The majority of the material in the first part of this document is taken from the free online course at <a href="https://supervised-ml-course.netlify.app/">https://supervised-ml-course.netlify.app/</a> written by Julia Silge.</p>
</div>
</div>
<p>In this case study, you will use data on attitudes and beliefs in the United States to predict voter turnout. You will apply your skills in dealing with imbalanced data and explore more resampling options.</p>
<section id="predicting-voter-turnout-from-survey-data" class="level2">
<h2 class="anchored" data-anchor-id="predicting-voter-turnout-from-survey-data">Predicting voter turnout from survey data ğŸ—³</h2>
<p>So far, you have built one regression model and one classification model, and now itâ€™s time for our third case study. In this case study, we are going to use a survey of voters in the United States to predict voter turnout, whether someone did or did not vote, based on their responses on the survey.</p>
<p>This data comes from a research collaboration of about two dozen analysts and scholars across the political spectrum in the United States who want to understand what is important to voters and how the views of the electorate in the U.S. are evolving.</p>
<p>Views of the Electorate Research Survey (VOTER) ğŸ‡ºğŸ‡¸</p>
<ul>
<li>Democracy Fund Voter Study Group</li>
<li>Politically diverse group of analysts and scholars in the United States</li>
<li>Data is freely available</li>
</ul>
<p>There are a lot of questions on this survey, so many that I canâ€™t go over them all with you in this course, but they are all about peopleâ€™s opinions on political and economic topics. The survey asks respondents how they feel about where the US economy is headed, whether they think their vote makes a difference, and how important various issues are to them.</p>
<p>Views of the Electorate Research Survey (VOTER) ğŸ‡ºğŸ‡¸</p>
<ul>
<li>Life in America today for people like you compared to fifty years ago is better? about the same? worse?</li>
<li>Was your vote primarily a vote in favor of your choice or was it mostly a vote against his/her opponent?</li>
<li>How important are the following issues to you? + Crime + Immigration + The environment + Gay rights</li>
</ul>
<p>The dataset that you have to work with in these exercises has about 40 variables, or questions on the survey, and the variable <code>turnout16_2016</code> tells us whether that respondent said they voted in the 2016 election or not. Notice that the answers to the survey questions have been coded as integers. This is actually pretty convenient for modeling, but in a situation like this, you need to look at a data dictionary or guide to understand what the integers mean.</p>
<p>For example, one of the questions asked survey respondents how much they agree or disagree with this statement about how fair society in America is and their responses are coded as these integers. All of the survey responses are coded as integers like this, which means we can use these responses directly for modeling. Iâ€™ll include the answers that correspond to the integers when itâ€™s relevant in this case study, but you can go get this data yourself as well.</p>
<p>We are going to build machine learning models to predict whether a respondent voted or not based on their responses to the survey questions. You are going to be able to use many of the approaches youâ€™ve been practicing already in the course, and develop some new ones.</p>
<p>Itâ€™s time for you to get started with this new dataset and see what you can learn.</p>
</section>
<section id="choose-an-appropriate-model" class="level2">
<h2 class="anchored" data-anchor-id="choose-an-appropriate-model">Choose an appropriate model</h2>
<p>In this case study, you will predict whether a person voted or not in the United States 2016 presidential election from responses that person gave on a survey. The survey focuses on opinions about political and economic topics. What kind of model will you build?</p>
<p><strong>To predict group membership or discrete class labels, use classification models.</strong></p>
</section>
<section id="explore-the-voter-data" class="level2">
<h2 class="anchored" data-anchor-id="explore-the-voter-data">Explore the VOTER data</h2>
<p>To do a good job with predictive modeling, you need to explore your dataset to understand it first. Start off this modeling analysis by checking out how many people voted or did not vote, and the answers to a few questions. The answers to the questions on this survey have been coded as integers, and the corresponding text has been provided for you here.</p>
<section id="instructions" class="level3">
<h3 class="anchored" data-anchor-id="instructions">Instructions</h3>
<ul>
<li>Load <code>tidyverse</code>.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tidyverse</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Take a look at voters to check out the data.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>voters <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../Data/voters.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a look at voters</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(voters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 6,692
Columns: 43
$ case_identifier      &lt;dbl&gt; 779, 2108, 2597, 4148, 4460, 5225, 5903, 6059, 80â€¦
$ turnout16_2016       &lt;chr&gt; "Voted", "Voted", "Voted", "Voted", "Voted", "Votâ€¦
$ RIGGED_SYSTEM_1_2016 &lt;dbl&gt; 3, 2, 2, 1, 3, 3, 3, 2, 4, 2, 3, 3, 4, 4, 3, 3, 2â€¦
$ RIGGED_SYSTEM_2_2016 &lt;dbl&gt; 4, 1, 4, 4, 1, 3, 4, 3, 4, 3, 2, 2, 3, 2, 4, 3, 2â€¦
$ RIGGED_SYSTEM_3_2016 &lt;dbl&gt; 1, 3, 1, 1, 3, 2, 1, 3, 1, 1, 1, 4, 1, 1, 1, 1, 3â€¦
$ RIGGED_SYSTEM_4_2016 &lt;dbl&gt; 4, 1, 4, 4, 1, 2, 1, 2, 3, 2, 4, 1, 3, 4, 2, 2, 1â€¦
$ RIGGED_SYSTEM_5_2016 &lt;dbl&gt; 3, 3, 1, 2, 3, 2, 2, 1, 3, 2, 2, 2, 3, 3, 2, 3, 2â€¦
$ RIGGED_SYSTEM_6_2016 &lt;dbl&gt; 2, 2, 1, 1, 2, 3, 1, 2, 1, 2, 1, 1, 1, 2, 1, 1, 2â€¦
$ track_2016           &lt;dbl&gt; 2, 2, 1, 1, 2, 2, 1, 2, 2, 2, 1, 2, 2, 3, 2, 2, 2â€¦
$ persfinretro_2016    &lt;dbl&gt; 2, 3, 3, 1, 2, 2, 2, 3, 2, 1, 2, 3, 2, 2, 2, 2, 2â€¦
$ econtrend_2016       &lt;dbl&gt; 1, 3, 3, 1, 2, 2, 1, 3, 1, 1, 1, 3, 2, 1, 4, 3, 2â€¦
$ Americatrend_2016    &lt;dbl&gt; 1, 1, 1, 3, 3, 1, 2, 3, 2, 1, 3, 3, 2, 1, 1, 3, 1â€¦
$ futuretrend_2016     &lt;dbl&gt; 4, 1, 1, 3, 4, 3, 1, 3, 1, 1, 3, 1, 1, 4, 3, 4, 3â€¦
$ wealth_2016          &lt;dbl&gt; 2, 1, 2, 2, 1, 2, 2, 1, 2, 2, 2, 1, 2, 2, 2, 2, 1â€¦
$ values_culture_2016  &lt;dbl&gt; 2, 3, 3, 3, 3, 2, 3, 3, 1, 3, 3, 2, 1, 1, 3, 8, 3â€¦
$ US_respect_2016      &lt;dbl&gt; 2, 3, 1, 1, 2, 2, 2, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3â€¦
$ trustgovt_2016       &lt;dbl&gt; 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3â€¦
$ trust_people_2016    &lt;dbl&gt; 8, 2, 1, 1, 1, 2, 2, 1, 2, 1, 2, 1, 2, 8, 8, 2, 2â€¦
$ helpful_people_2016  &lt;dbl&gt; 1, 1, 2, 1, 1, 1, 2, 2, 1, 2, 2, 1, 1, 2, 8, 1, 1â€¦
$ fair_people_2016     &lt;dbl&gt; 8, 2, 1, 1, 1, 2, 2, 1, 2, 1, 1, 1, 2, 2, 8, 2, 1â€¦
$ imiss_a_2016         &lt;dbl&gt; 2, 1, 1, 1, 1, 2, 1, 1, 3, 1, 1, 1, 2, 1, 2, 2, 2â€¦
$ imiss_b_2016         &lt;dbl&gt; 2, 1, 1, 2, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1â€¦
$ imiss_c_2016         &lt;dbl&gt; 1, 2, 2, 3, 1, 2, 2, 1, 4, 2, 3, 1, 2, 2, 3, 1, 1â€¦
$ imiss_d_2016         &lt;dbl&gt; 1, 2, 1, 1, 1, 1, 1, 2, 1, 1, 1, 3, 2, 1, 1, 1, 3â€¦
$ imiss_e_2016         &lt;dbl&gt; 1, 1, 3, 1, 1, 3, 1, 2, 1, 1, 2, 2, 4, 1, 4, 2, 1â€¦
$ imiss_f_2016         &lt;dbl&gt; 2, 1, 1, 2, 1, 2, 1, 3, 2, 1, 1, 1, 2, 1, 3, 2, 2â€¦
$ imiss_g_2016         &lt;dbl&gt; 1, 4, 3, 3, 3, 1, 3, 4, 2, 2, 1, 4, 1, 2, 1, 1, 4â€¦
$ imiss_h_2016         &lt;dbl&gt; 1, 2, 2, 2, 1, 1, 1, 2, 1, 1, 1, 2, 1, 1, 1, 1, 3â€¦
$ imiss_i_2016         &lt;dbl&gt; 2, 2, 4, 4, 2, 1, 1, 3, 2, 1, 1, 2, 1, 2, 2, 2, 3â€¦
$ imiss_j_2016         &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2â€¦
$ imiss_k_2016         &lt;dbl&gt; 1, 2, 1, 1, 2, 1, 1, 4, 2, 1, 1, 3, 1, 1, 1, 1, 1â€¦
$ imiss_l_2016         &lt;dbl&gt; 1, 4, 1, 2, 4, 1, 1, 3, 1, 1, 1, 4, 2, 1, 1, 1, 3â€¦
$ imiss_m_2016         &lt;dbl&gt; 1, 2, 1, 2, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1â€¦
$ imiss_n_2016         &lt;dbl&gt; 1, 2, 1, 1, 1, 1, 1, 2, 2, 1, 1, 2, 2, 1, 1, 1, 1â€¦
$ imiss_o_2016         &lt;dbl&gt; 2, 1, 1, 1, 1, 2, 1, 2, 2, 1, 1, 2, 2, 2, 2, 1, 1â€¦
$ imiss_p_2016         &lt;dbl&gt; 2, 1, 2, 3, 1, 3, 1, 1, 4, 1, 1, 1, 2, 3, 2, 3, 1â€¦
$ imiss_q_2016         &lt;dbl&gt; 1, 1, 1, 2, 2, 1, 1, 4, 2, 1, 1, 3, 1, 1, 2, 2, 3â€¦
$ imiss_r_2016         &lt;dbl&gt; 2, 1, 1, 2, 1, 2, 1, 2, 4, 2, 2, 1, 3, 2, 2, 2, 1â€¦
$ imiss_s_2016         &lt;dbl&gt; 1, 2, 1, 2, 2, 1, 1, 1, 1, 1, 1, 3, 1, 1, 1, 1, 3â€¦
$ imiss_t_2016         &lt;dbl&gt; 1, 1, 3, 3, 1, 1, 3, 4, 1, 1, 1, 3, 1, 3, 1, 1, 3â€¦
$ imiss_u_2016         &lt;dbl&gt; 2, 2, 2, 2, 1, 3, 3, 1, 4, 2, 3, 2, 4, 3, 3, 3, 1â€¦
$ imiss_x_2016         &lt;dbl&gt; 1, 3, 1, 2, 1, 1, 1, 4, 1, 1, 1, 2, 1, 1, 1, 2, 3â€¦
$ imiss_y_2016         &lt;dbl&gt; 1, 4, 2, 3, 1, 1, 1, 3, 2, 1, 1, 3, 1, 1, 1, 2, 2â€¦</code></pre>
</div>
</div>
<ul>
<li>In the call to <code>count()</code>, use the appropriate variable (<code>turnout16_2016</code>) to see how many examples you have of those who voted and did not vote.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many people voted?</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>voters <span class="sc">|&gt;</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(turnout16_2016)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 Ã— 2
  turnout16_2016     n
  &lt;chr&gt;          &lt;int&gt;
1 Did not vote     264
2 Voted           6428</code></pre>
</div>
</div>
<ul>
<li>Check out how three responses on the survey vary with voting behavior by using <code>group_by()</code> and <code>summarise()</code>.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How do the responses on the survey vary with voting behavior?</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>voters <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(turnout16_2016) <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="st">`</span><span class="at">Elections don't matter</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(RIGGED_SYSTEM_1_2016 <span class="sc">&lt;=</span> <span class="dv">2</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>              <span class="st">`</span><span class="at">Economy is getting better</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(econtrend_2016 <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>              <span class="st">`</span><span class="at">Crime is very important</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">mean</span>(imiss_a_2016 <span class="sc">==</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 Ã— 4
  turnout16_2016 `Elections don't matter` `Economy is getting better`
  &lt;chr&gt;                             &lt;dbl&gt;                       &lt;dbl&gt;
1 Did not vote                      0.553                       0.163
2 Voted                             0.341                       0.289
# â„¹ 1 more variable: `Crime is very important` &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="visualization-for-exploratory-analysis" class="level2">
<h2 class="anchored" data-anchor-id="visualization-for-exploratory-analysis">Visualization for exploratory analysis</h2>
<p>Visualization is a powerful tool for exploratory data analysis. Plotting your data before you start modeling gives you the opportunity to understand its characteristics. ğŸ“ˆ</p>
<section id="instructions-1" class="level3">
<h3 class="anchored" data-anchor-id="instructions-1">Instructions</h3>
<ul>
<li><p>Call <code>ggplot()</code> to initialize a new plot.</p></li>
<li><p>Use the correct <code>ggplot2</code> geom to make a histogram of survey responses for one question (<code>econtrend_2016</code>) and examine the difference by voting behavior.</p></li>
</ul>
<p>On this question about how the economy is doing, an answer of 1 indicates â€œgetting betterâ€, 2 indicates â€œabout the sameâ€, 3 indicates â€œgetting worseâ€, and 4 indicates â€œdonâ€™t knowâ€.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>voters <span class="ot">&lt;-</span> voters <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">turnout16_2016 =</span> <span class="fu">factor</span>(turnout16_2016))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Visualize difference by voter turnout</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>voters <span class="sc">|&gt;</span> </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(econtrend_2016, </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>               <span class="fu">after_stat</span>(density), </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> turnout16_2016)) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">position =</span> <span class="st">"identity"</span>, </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Overall, is the economy getting better or worse?"</span>) <span class="sc">+</span> </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="VOTERS_files/figure-html/visualize-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Consider this one</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> voters,  <span class="fu">aes</span>(<span class="at">x =</span> econtrend_2016, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">fill =</span> turnout16_2016, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">after_stat</span>(density))) <span class="sc">+</span> </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">position =</span> <span class="st">"identity"</span>, </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">binwidth =</span> <span class="dv">1</span>, </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(turnout16_2016)) <span class="sc">+</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="VOTERS_files/figure-html/visualize-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="imbalanced-data" class="level2">
<h2 class="anchored" data-anchor-id="imbalanced-data">Imbalanced data</h2>
<p>This is real data from the real world, so you need to think through important modeling concerns, including how imbalanced the class is that you want to predict. You have been exploring this data set in the past few exercises. What is your assessment?</p>
<p><strong>There are over <span class="math inline">\(6428/264 \approx 24.34\)</span> times more people in this survey who said they did vote than who said they did not vote.</strong></p>
</section>
<section id="training-and-testing-data" class="level2">
<h2 class="anchored" data-anchor-id="training-and-testing-data">Training and testing data</h2>
<p>Itâ€™s time to split your data into training and testing sets, in the same way that you created these subsets in the previous case studies. You want to split your data about evenly on the class <code>turnout16_2016.</code></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>voters_select <span class="ot">&lt;-</span> voters  <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">turnout16_2016 =</span> <span class="fu">factor</span>(turnout16_2016)) <span class="sc">|&gt;</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>case_identifier) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="instructions-2" class="level3">
<h3 class="anchored" data-anchor-id="instructions-2">Instructions</h3>
<ul>
<li><p>Load the <code>tidymodels</code> metapackage, for using the functions to split your data.</p></li>
<li><p>Use the correct function to create a data split that divides <code>voters_select</code> into 80%/20% sections.</p></li>
<li><p>Assign the 80% partition to <code>vote_train</code> and the 20% partition to <code>vote_test</code>.</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tidymodels</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data into training and testing sets</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>vote_split <span class="ot">&lt;-</span> voters_select <span class="sc">|&gt;</span> </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">initial_split</span>(<span class="at">prop =</span> <span class="fl">0.8</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata =</span> turnout16_2016)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>vote_train <span class="ot">&lt;-</span> <span class="fu">training</span>(vote_split)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>vote_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(vote_split)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(vote_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 5,353
Columns: 42
$ turnout16_2016       &lt;fct&gt; Voted, Voted, Voted, Voted, Voted, Voted, Voted, â€¦
$ RIGGED_SYSTEM_1_2016 &lt;dbl&gt; 3, 2, 1, 3, 3, 3, 4, 2, 3, 4, 4, 3, 3, 2, 3, 2, 4â€¦
$ RIGGED_SYSTEM_2_2016 &lt;dbl&gt; 4, 4, 4, 1, 3, 4, 4, 3, 2, 3, 2, 4, 3, 2, 3, 3, 1â€¦
$ RIGGED_SYSTEM_3_2016 &lt;dbl&gt; 1, 1, 1, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 3, 2, 2, 2â€¦
$ RIGGED_SYSTEM_4_2016 &lt;dbl&gt; 4, 4, 4, 1, 2, 1, 3, 2, 4, 3, 4, 2, 2, 1, 1, 1, 1â€¦
$ RIGGED_SYSTEM_5_2016 &lt;dbl&gt; 3, 1, 2, 3, 2, 2, 3, 2, 2, 3, 3, 2, 3, 2, 1, 2, 2â€¦
$ RIGGED_SYSTEM_6_2016 &lt;dbl&gt; 2, 1, 1, 2, 3, 1, 1, 2, 1, 1, 2, 1, 1, 2, 1, 1, 1â€¦
$ track_2016           &lt;dbl&gt; 2, 1, 1, 2, 2, 1, 2, 2, 1, 2, 3, 2, 2, 2, 2, 2, 2â€¦
$ persfinretro_2016    &lt;dbl&gt; 2, 3, 1, 2, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3â€¦
$ econtrend_2016       &lt;dbl&gt; 1, 3, 1, 2, 2, 1, 1, 1, 1, 2, 1, 4, 3, 2, 2, 2, 3â€¦
$ Americatrend_2016    &lt;dbl&gt; 1, 1, 3, 3, 1, 2, 2, 1, 3, 2, 1, 1, 3, 1, 4, 3, 3â€¦
$ futuretrend_2016     &lt;dbl&gt; 4, 1, 3, 4, 3, 1, 1, 1, 3, 1, 4, 3, 4, 3, 1, 3, 3â€¦
$ wealth_2016          &lt;dbl&gt; 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2, 2, 1â€¦
$ values_culture_2016  &lt;dbl&gt; 2, 3, 3, 3, 2, 3, 1, 3, 3, 1, 1, 3, 8, 3, 3, 3, 3â€¦
$ US_respect_2016      &lt;dbl&gt; 2, 1, 1, 2, 2, 2, 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3â€¦
$ trustgovt_2016       &lt;dbl&gt; 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3â€¦
$ trust_people_2016    &lt;dbl&gt; 8, 1, 1, 1, 2, 2, 2, 1, 2, 2, 8, 8, 2, 2, 2, 2, 1â€¦
$ helpful_people_2016  &lt;dbl&gt; 1, 2, 1, 1, 1, 2, 1, 2, 2, 1, 2, 8, 1, 1, 2, 1, 2â€¦
$ fair_people_2016     &lt;dbl&gt; 8, 1, 1, 1, 2, 2, 2, 1, 1, 2, 2, 8, 2, 1, 2, 2, 1â€¦
$ imiss_a_2016         &lt;dbl&gt; 2, 1, 1, 1, 2, 1, 3, 1, 1, 2, 1, 2, 2, 2, 1, 2, 1â€¦
$ imiss_b_2016         &lt;dbl&gt; 2, 1, 2, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1â€¦
$ imiss_c_2016         &lt;dbl&gt; 1, 2, 3, 1, 2, 2, 4, 2, 3, 2, 2, 3, 1, 1, 1, 1, 1â€¦
$ imiss_d_2016         &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 3, 2, 4, 2â€¦
$ imiss_e_2016         &lt;dbl&gt; 1, 3, 1, 1, 3, 1, 1, 1, 2, 4, 1, 4, 2, 1, 1, 2, 1â€¦
$ imiss_f_2016         &lt;dbl&gt; 2, 1, 2, 1, 2, 1, 2, 1, 1, 2, 1, 3, 2, 2, 1, 2, 2â€¦
$ imiss_g_2016         &lt;dbl&gt; 1, 3, 3, 3, 1, 3, 2, 2, 1, 1, 2, 1, 1, 4, 3, 4, 3â€¦
$ imiss_h_2016         &lt;dbl&gt; 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 2, 2â€¦
$ imiss_i_2016         &lt;dbl&gt; 2, 4, 4, 2, 1, 1, 2, 1, 1, 1, 2, 2, 2, 3, 3, 3, 2â€¦
$ imiss_j_2016         &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1â€¦
$ imiss_k_2016         &lt;dbl&gt; 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 4, 1, 2â€¦
$ imiss_l_2016         &lt;dbl&gt; 1, 1, 2, 4, 1, 1, 1, 1, 1, 2, 1, 1, 1, 3, 3, 4, 4â€¦
$ imiss_m_2016         &lt;dbl&gt; 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 2â€¦
$ imiss_n_2016         &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 1, 1, 3, 1, 2â€¦
$ imiss_o_2016         &lt;dbl&gt; 2, 1, 1, 1, 2, 1, 2, 1, 1, 2, 2, 2, 1, 1, 1, 1, 1â€¦
$ imiss_p_2016         &lt;dbl&gt; 2, 2, 3, 1, 3, 1, 4, 1, 1, 2, 3, 2, 3, 1, 2, 2, 1â€¦
$ imiss_q_2016         &lt;dbl&gt; 1, 1, 2, 2, 1, 1, 2, 1, 1, 1, 1, 2, 2, 3, 3, 1, 3â€¦
$ imiss_r_2016         &lt;dbl&gt; 2, 1, 2, 1, 2, 1, 4, 2, 2, 3, 2, 2, 2, 1, 1, 2, 1â€¦
$ imiss_s_2016         &lt;dbl&gt; 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 1, 1â€¦
$ imiss_t_2016         &lt;dbl&gt; 1, 3, 3, 1, 1, 3, 1, 1, 1, 1, 3, 1, 1, 3, 3, 3, 4â€¦
$ imiss_u_2016         &lt;dbl&gt; 2, 2, 2, 1, 3, 3, 4, 2, 3, 4, 3, 3, 3, 1, 1, 2, 1â€¦
$ imiss_x_2016         &lt;dbl&gt; 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 3, 3, 3â€¦
$ imiss_y_2016         &lt;dbl&gt; 1, 2, 3, 1, 1, 1, 2, 1, 1, 1, 1, 1, 2, 2, 4, 3, 3â€¦</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(vote_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,339
Columns: 42
$ turnout16_2016       &lt;fct&gt; Voted, Voted, Voted, Voted, Voted, Voted, Voted, â€¦
$ RIGGED_SYSTEM_1_2016 &lt;dbl&gt; 2, 2, 3, 4, 3, 3, 3, 3, 3, 3, 2, 2, 2, 3, 3, 1, 3â€¦
$ RIGGED_SYSTEM_2_2016 &lt;dbl&gt; 1, 3, 2, 3, 2, 1, 2, 2, 2, 2, 2, 1, 4, 3, 1, 4, 2â€¦
$ RIGGED_SYSTEM_3_2016 &lt;dbl&gt; 3, 3, 4, 1, 2, 2, 2, 2, 2, 2, 2, 3, 1, 2, 3, 1, 2â€¦
$ RIGGED_SYSTEM_4_2016 &lt;dbl&gt; 1, 2, 1, 3, 3, 3, 2, 2, 2, 2, 1, 1, 2, 3, 1, 2, 3â€¦
$ RIGGED_SYSTEM_5_2016 &lt;dbl&gt; 3, 1, 2, 1, 2, 2, 3, 2, 4, 3, 1, 1, 1, 3, 3, 1, 2â€¦
$ RIGGED_SYSTEM_6_2016 &lt;dbl&gt; 2, 2, 1, 2, 1, 4, 2, 2, 1, 2, 1, 1, 1, 2, 2, 1, 2â€¦
$ track_2016           &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 2, 2, 2, 3, 1, 2, 2â€¦
$ persfinretro_2016    &lt;dbl&gt; 3, 3, 3, 2, 2, 1, 1, 2, 1, 3, 2, 3, 2, 2, 3, 1, 2â€¦
$ econtrend_2016       &lt;dbl&gt; 3, 3, 3, 2, 1, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2â€¦
$ Americatrend_2016    &lt;dbl&gt; 1, 3, 3, 3, 2, 1, 1, 3, 3, 3, 1, 1, 2, 1, 2, 3, 1â€¦
$ futuretrend_2016     &lt;dbl&gt; 1, 3, 1, 4, 1, 1, 1, 3, 4, 1, 2, 3, 3, 2, 4, 3, 3â€¦
$ wealth_2016          &lt;dbl&gt; 1, 1, 1, 2, 2, 1, 1, 2, 1, 1, 1, 8, 2, 2, 1, 2, 2â€¦
$ values_culture_2016  &lt;dbl&gt; 3, 3, 2, 3, 2, 3, 3, 3, 3, 2, 3, 3, 3, 1, 3, 2, 3â€¦
$ US_respect_2016      &lt;dbl&gt; 3, 3, 3, 3, 2, 3, 3, 3, 3, 1, 3, 3, 3, 2, 3, 3, 2â€¦
$ trustgovt_2016       &lt;dbl&gt; 3, 3, 3, 2, 2, 3, 3, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3â€¦
$ trust_people_2016    &lt;dbl&gt; 2, 1, 1, 2, 2, 2, 2, 1, 2, 2, 2, 2, 1, 2, 1, 1, 2â€¦
$ helpful_people_2016  &lt;dbl&gt; 1, 2, 1, 1, 1, 2, 1, 2, 1, 1, 1, 2, 8, 2, 2, 2, 1â€¦
$ fair_people_2016     &lt;dbl&gt; 2, 1, 1, 2, 2, 2, 2, 1, 2, 8, 2, 2, 8, 8, 1, 1, 2â€¦
$ imiss_a_2016         &lt;dbl&gt; 1, 1, 1, 2, 2, 3, 2, 2, 1, 2, 1, 1, 2, 1, 1, 2, 2â€¦
$ imiss_b_2016         &lt;dbl&gt; 1, 2, 1, 1, 1, 2, 2, 1, 1, 2, 1, 1, 1, 2, 2, 1, 1â€¦
$ imiss_c_2016         &lt;dbl&gt; 2, 1, 1, 1, 3, 4, 2, 2, 2, 2, 1, 1, 1, 3, 1, 2, 3â€¦
$ imiss_d_2016         &lt;dbl&gt; 2, 2, 3, 2, 2, 1, 2, 1, 1, 3, 3, 1, 1, 2, 2, 1, 1â€¦
$ imiss_e_2016         &lt;dbl&gt; 1, 2, 2, 2, 2, 3, 2, 2, 2, 3, 1, 1, 1, 1, 2, 4, 4â€¦
$ imiss_f_2016         &lt;dbl&gt; 1, 3, 1, 2, 1, 3, 2, 2, 1, 2, 1, 1, 2, 2, 1, 2, 2â€¦
$ imiss_g_2016         &lt;dbl&gt; 4, 4, 4, 1, 2, 2, 2, 3, 1, 4, 4, 1, 3, 1, 3, 1, 1â€¦
$ imiss_h_2016         &lt;dbl&gt; 2, 2, 2, 1, 3, 2, 2, 2, 1, 2, 2, 1, 1, 1, 2, 1, 1â€¦
$ imiss_i_2016         &lt;dbl&gt; 2, 3, 2, 2, 3, 4, 3, 3, 2, 3, 4, 1, 2, 2, 4, 1, 2â€¦
$ imiss_j_2016         &lt;dbl&gt; 1, 1, 1, 1, 1, 3, 2, 1, 1, 2, 2, 1, 1, 1, 2, 1, 1â€¦
$ imiss_k_2016         &lt;dbl&gt; 2, 4, 3, 2, 2, 2, 2, 2, 2, 2, 4, 3, 1, 1, 2, 1, 1â€¦
$ imiss_l_2016         &lt;dbl&gt; 4, 3, 4, 2, 1, 1, 2, 1, 2, 4, 4, 4, 1, 1, 4, 1, 1â€¦
$ imiss_m_2016         &lt;dbl&gt; 2, 1, 2, 1, 1, 4, 2, 1, 1, 2, 2, 1, 1, 2, 2, 1, 1â€¦
$ imiss_n_2016         &lt;dbl&gt; 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 2, 1, 1â€¦
$ imiss_o_2016         &lt;dbl&gt; 1, 2, 2, 1, 2, 2, 2, 1, 1, 2, 1, 1, 1, 2, 2, 1, 1â€¦
$ imiss_p_2016         &lt;dbl&gt; 1, 1, 1, 3, 2, 3, 2, 2, 2, 2, 2, 1, 2, 2, 1, 2, 3â€¦
$ imiss_q_2016         &lt;dbl&gt; 1, 4, 3, 1, 1, 3, 2, 2, 1, 2, 3, 1, 1, 1, 2, 1, 1â€¦
$ imiss_r_2016         &lt;dbl&gt; 1, 2, 1, 3, 2, 4, 2, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1â€¦
$ imiss_s_2016         &lt;dbl&gt; 2, 1, 3, 1, 1, 4, 2, 1, 2, 2, 2, 1, 1, 2, 1, 1, 1â€¦
$ imiss_t_2016         &lt;dbl&gt; 1, 4, 3, 3, 3, 4, 2, 2, 2, 3, 2, 1, 2, 2, 3, 1, 2â€¦
$ imiss_u_2016         &lt;dbl&gt; 2, 1, 2, 3, 3, 3, 2, 3, 2, 1, 1, 1, 2, 2, 2, 2, 4â€¦
$ imiss_x_2016         &lt;dbl&gt; 3, 4, 2, 2, 2, 3, 2, 2, 2, 3, 3, 2, 1, 1, 2, 1, 1â€¦
$ imiss_y_2016         &lt;dbl&gt; 4, 3, 3, 2, 1, 4, 2, 2, 1, 3, 4, 3, 2, 1, 3, 1, 1â€¦</code></pre>
</div>
</div>
</section>
</section>
<section id="vote-2016" class="level2">
<h2 class="anchored" data-anchor-id="vote-2016">VOTE 2016 ğŸ‡ºğŸ‡¸</h2>
<p>To do a good job with predictive modeling, you need to explore and understand your data before you start building machine learning models. When you do exploratory data analysis, you learn important things, such as how imbalanced the class you are trying to predict isâ€¦</p>
<p>â€¦and how much of a difference you see in survey responses between the two groups. We see here that people who say that elections donâ€™t matter and things stay the same no matter who we vote in were less likely to vote, while people who think that gay rights are important were more likely to vote. We can see differences like this for many of the survey questions.</p>
<p>Visualizing your data before modeling is always a good idea. ğŸ‘</p>
<p>Here, for example, we can see that people who say the economy is getting better are more likely to vote.</p>
<p>This is another case study with imbalanced data. We are again going to preprocess our training data so we can build a better performing model, but this time we are going to <strong>upsample</strong> (or oversample) our data.</p>
<p>When we implement upsampling, we add more of the people who did not vote (just more of the same ones we already have) until the proportion is equal and the classes are balanced.</p>
<p>We are going to use <a href="https://themis.tidymodels.org/reference/step_upsample.html"><code>step_upsample()</code></a> for oversampling because it is simple to implement and understand, but it can lead a classifier to overfit to just a few examples, if youâ€™re not lucky. There are other more complex approaches to oversampling available in the <code>themis</code> package as well, but we will focus on random upsampling with replacement here.</p>
<p>Upsampling is another example of a preprocessing step for modeling. You can again preprocess your data using <a href="https://recipes.tidymodels.org/">recipes</a>. The recipe shown below has just one preprocessing step (upsampling) but you can create recipes for preprocessing with as many steps as you need.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>vote_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(turnout16_2016 <span class="sc">~</span> ., <span class="at">data =</span> vote_train) <span class="sc">|&gt;</span>  </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_upsample</span>(turnout16_2016)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To put our recipe and our model specification together, letâ€™s use a <code>workflow()</code>. We can fit our workflow much like we would fit a model.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Specify a ranger model</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>()  <span class="sc">|&gt;</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>vote_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>()  <span class="sc">|&gt;</span> </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(vote_recipe)  <span class="sc">|&gt;</span> </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(rf_spec)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>vote_wf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>â•â• Workflow â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Preprocessor: Recipe
Model: rand_forest()

â”€â”€ Preprocessor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1 Recipe Step

â€¢ step_upsample()

â”€â”€ Model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Random Forest Model Specification (classification)

Computational engine: ranger </code></pre>
</div>
</div>
<p>Now that you have explored your data and have some understanding of it, itâ€™s time to move into machine learning.</p>
</section>
<section id="preprocess-with-a-recipe" class="level2">
<h2 class="anchored" data-anchor-id="preprocess-with-a-recipe">Preprocess with a recipe</h2>
<p>This dataset needs to prepared for modeling.</p>
<section id="instructions-3" class="level3">
<h3 class="anchored" data-anchor-id="instructions-3">Instructions</h3>
<ul>
<li><p>Use a <code>recipe()</code> to preprocess your training data, <code>vote_train</code>.</p></li>
<li><p>Upsample this training data with the function <code>step_upsample()</code>.</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>vote_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(turnout16_2016 <span class="sc">~</span> ., <span class="at">data =</span> vote_train) <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_upsample</span>(turnout16_2016)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>vote_recipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="creating-a-modeling-workflow" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-modeling-workflow">Creating a modeling workflow</h2>
<p>In this case study, weâ€™ll experiment with a new engine for the random forest model, the <code>ranger</code> package. You can combine the model with your preprocessing steps (your recipe) in a <a href="https://workflows.tidymodels.org/"><code>workflow()</code></a> for convenience.</p>
<section id="instructions-4" class="level3">
<h3 class="anchored" data-anchor-id="instructions-4">Instructions</h3>
<ul>
<li>Use <code>rand_forest()</code> to specify a random forest model. Notice that we are using a different engine than in the first case study.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Specify a ranger model</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>()  <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Add the recipe and the model specification to the workflow.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Add the recipe + model to a workflow</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>vote_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>()  <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(vote_recipe)  <span class="sc">|&gt;</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(rf_spec)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Show vote_wf</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>vote_wf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>â•â• Workflow â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Preprocessor: Recipe
Model: rand_forest()

â”€â”€ Preprocessor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1 Recipe Step

â€¢ step_upsample()

â”€â”€ Model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Random Forest Model Specification (classification)

Computational engine: ranger </code></pre>
</div>
</div>
</section>
</section>
<section id="cross-validation" class="level2">
<h2 class="anchored" data-anchor-id="cross-validation">Cross-validation</h2>
<p>You have created a training set and testing set and laid out how to deal with class imbalance via upsampling. Now itâ€™s time to talk about a new resampling approach. In the first case study, we used bootstrap resampling and talked through what that means. In this chapter, weâ€™re going to use cross-validation.</p>
<p>Cross-validation means taking your training set and randomly dividing it up evenly into subsets, sometimes called â€œfoldsâ€. A fold here means a group or subset or partition.</p>
<p>You use one of the folds for validation and the rest for training, then you repeat these steps with all the subsets and combine the results, usually by taking the mean. The reason we do this is the same reason we would use bootstrap resampling; cross-validation allows you to get a more accurate estimate of how your model will perform on new data.</p>
<p>In <code>tidymodels</code>, you can create cross-validation <code>resamples</code> with the function <code>vfold_cv()</code>, either with or without the <code>repeats</code> argument.</p>
<p>Letâ€™s look at this in more detail. ğŸ§</p>
<ul>
<li><code>vfold_cv(vote_train, v = 10)</code></li>
<li><code>vfold_cv(vote_train, v = 10, repeats = 5)</code></li>
</ul>
<p>Letâ€™s say we have a sample of lots of people, some of whom voted and some of whom did not, and we want to implement 10-fold cross-validation. This means we divide our training data into 10 groups or folds, and 1 subset or fold acts as our assessment fold (like a mini testing test). We train our model on 9 of the folds and then evaluate the model on the assessment fold.</p>
<p>If we are using preprocessing steps such as upsampling that should only be applied to the 9/10 of the data used for analysis (not the 1/10 of the data used for assessment), the recipes package will automatically take care of that for us. ğŸ‘</p>
<p>Now we move to the next fold and do this again. We train the model on the rest of the data, the other 9 folds, and evaluate the model on 1/10 of the data, the fold that is currently acting as our assessment fold.</p>
<p>We do it again using another of our folds as the assessment fold, training the model on the rest of the data, and we move through all the subsets or folds of the data that we madeâ€¦</p>
<p>.. until we do them all, and have trained the model 10 times, on 10 different subsets of the data, with 10 different assessment sets. We then combine all those results together to get one, better estimate of how our model will perform.</p>
<p>This procedure I just described is one round of 10-fold cross-validation. Sometimes practictioners do this more than once, perhaps 5 times. In that case, you repeat the whole process of 10-fold cross-validation 5 times, with 5 different random partitionings into 10 subsets. This is an approach to training models that has demonstrated good performance.</p>
<p>However, it can be computationally expensive. â³ It does lend itself to parallel processing, since the repeats donâ€™t depend on each other, so this is a situation where it likely is worth getting your computer set up to use all the cores you have.</p>
<p>Cross-validation</p>
<ul>
<li>Repeated cross-validation can take a long time</li>
<li>Parallel processing can be worth it</li>
</ul>
</section>
<section id="understanding-cross-validation" class="level2">
<h2 class="anchored" data-anchor-id="understanding-cross-validation">Understanding cross-validation</h2>
<p>When you implement 10-fold cross-validation repeated 5 times, you randomly divide your training data into 10 subsets and train on 9 at a time (assessing on the other subset), iterating through all 10 subsets for assessment. Then you repeat that process 5 times. Simulations and practical experience show that 10-fold cross-validation repeated 5 times is a great resampling approach for many situations. This approach involves randomly dividing your training data into 10 folds, or subsets or groups, and training on only 9 while using the other fold for assessment. You iterate through all 10 folds being used for assessment; this is one round of cross-validation. You can then repeat the whole process multiple, perhaps 5, times.</p>
</section>
<section id="create-cross-validation-folds" class="level2">
<h2 class="anchored" data-anchor-id="create-cross-validation-folds">Create cross-validation folds</h2>
<p>You can use tidymodels functions to create the kind of cross-validation folds appropriate for your use case. Here, try 10-fold cross-validation repeated 5 times.</p>
<section id="instructions-5" class="level3">
<h3 class="anchored" data-anchor-id="instructions-5">Instructions</h3>
<ul>
<li>The argument <code>v</code> specifies the number of folds for cross-validation.</li>
<li>The argument <code>repeats</code> specifies the number of repeats.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>vote_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(vote_train, <span class="at">v =</span> <span class="dv">10</span>, <span class="at">repeats =</span> <span class="dv">5</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(vote_folds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 50
Columns: 3
$ splits &lt;list&gt; [&lt;vfold_split[4817 x 536 x 5353 x 42]&gt;], [&lt;vfold_split[4817 x â€¦
$ id     &lt;chr&gt; "Repeat1", "Repeat1", "Repeat1", "Repeat1", "Repeat1", "Repeat1â€¦
$ id2    &lt;chr&gt; "Fold01", "Fold02", "Fold03", "Fold04", "Fold05", "Fold06", "Foâ€¦</code></pre>
</div>
</div>
</section>
</section>
<section id="evaluate-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-model-performance">Evaluate model performance</h2>
<p>Excellent job! You preprocessed this data, built a modeling workflow, and created cross-validation folds to evaluate model performance. ğŸ˜</p>
<p>Letâ€™s talk about that model performance now, how to set non-default performance metrics and save predictions from resampled data.</p>
<p>Just like in our first case study, we can use the function <code>fit_resamples()</code> to fit a model (a workflow in this case, actually, that holds both a preprocessor and a model specification) to each cross-validation fold and compute performance metrics. The code shown below will fit our workflow <code>vote_wf</code> to the cross-validation folds in <code>vote_folds</code> and determine how well the model performed each time.</p>
<p>The fitted models themselves are not kept or stored because they are only used for computing performance metrics. However, we are saving the predictions with <code>save_pred = TRUE</code> so we can build a confusion matrix, and we have also set specific performance metrics to be computed (instead of the defaults) with <code>metric_set(roc_auc, sensitivity, specificity)</code>. We will have:</p>
<ul>
<li>the area under the ROC curve,</li>
<li>sensitivity, and</li>
<li>specificity.</li>
</ul>
<div class="cell" data-layout-align="center" data-hash="VOTERS_cache/html/unnamed-chunk-15_edd4c61a34978ce35e1468c93c27ec3a">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluating models with resampling. </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>vote_wf <span class="sc">|&gt;</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit_resamples</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">resamples =</span> vote_folds,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">metrics =</span> <span class="fu">metric_set</span>(roc_auc, sensitivity, specificity),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Resampling results
# 10-fold cross-validation repeated 5 times 
# A tibble: 50 Ã— 6
   splits             id      id2    .metrics         .notes   .predictions
   &lt;list&gt;             &lt;chr&gt;   &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;   &lt;list&gt;      
 1 &lt;split [4817/536]&gt; Repeat1 Fold01 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
 2 &lt;split [4817/536]&gt; Repeat1 Fold02 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
 3 &lt;split [4817/536]&gt; Repeat1 Fold03 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
 4 &lt;split [4818/535]&gt; Repeat1 Fold04 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
 5 &lt;split [4818/535]&gt; Repeat1 Fold05 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
 6 &lt;split [4818/535]&gt; Repeat1 Fold06 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
 7 &lt;split [4818/535]&gt; Repeat1 Fold07 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
 8 &lt;split [4818/535]&gt; Repeat1 Fold08 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
 9 &lt;split [4818/535]&gt; Repeat1 Fold09 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
10 &lt;split [4818/535]&gt; Repeat1 Fold10 &lt;tibble [3 Ã— 4]&gt; &lt;tibble&gt; &lt;tibble&gt;    
# â„¹ 40 more rows</code></pre>
</div>
</div>
<p>If we start by looking at the metrics for the logistic regression model, you can see that sensitivity and specificity (the true positive and true negative rates) are both around 0.6 or 0.7, which means that most people are being classified into the right categories but we are not getting fantastic results with this model.</p>
<p>When we look at the metrics for the random forest model, we see that the AUC is higher, but sensitivity (the true positive rate, or recall) has dropped to zero! ğŸ˜± The random forest model is not able to identify any of the people who did not vote.</p>
<p>What weâ€™re seeing here is evidence of dramatic overfitting, despite the fact that we used cross-validation. For the amount of data we have available to train this model, the power of a random forest ends up resulting in memorization of the features of the training set, instead of building a useful predictive model. Our choice to use upsampling (where the same small number of positive cases were drawn from again and again) likely made this worse!</p>
<p>Notice that this is the first time that this has happened in this course. In the first and second case studies we did, the more powerful machine learning algorithm outperformed the simpler model.</p>
<p>The logistic regression model will likely be the best option, so we can evaluate its performance on the testing data. We can use the <code>last_fit()</code> function with a workflow to fit to the entire training set and evaluate on the testing set. You only need to give this function the split object!</p>
<p>We can see that we did a better job identifying the people who voted than those who did not.</p>
<div class="cell" data-layout-align="center" data-hash="VOTERS_cache/html/unnamed-chunk-16_f61ee37900ac73821bcb48f946f70cec">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Who is working?</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>vote_final <span class="ot">&lt;-</span> vote_wf  <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">last_fit</span>(vote_split)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>vote_final <span class="sc">|&gt;</span>  </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect_predictions</span>() <span class="sc">|&gt;</span> </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conf_mat</span>(turnout16_2016, .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Truth
Prediction     Did not vote Voted
  Did not vote            0     0
  Voted                  53  1286</code></pre>
</div>
</div>
<p>Before we wrap up this case study, itâ€™s time for you to evaluate these models for yourself.</p>
</section>
<section id="resampling-two-models" class="level2">
<h2 class="anchored" data-anchor-id="resampling-two-models">Resampling two models</h2>
<p>Letâ€™s use cross-validation resampling to evaluate performance for two kinds of models with this vote data. Youâ€™ve already learned how to create resamples, preprocess data for modeling, build a model specification, and combine this in a workflow; now itâ€™s time to put this all together and evaluate this modelâ€™s performance.</p>
<section id="instructions-6" class="level3">
<h3 class="anchored" data-anchor-id="instructions-6">Instructions</h3>
<ul>
<li><p>Use <code>fit_resamples()</code> to evaluate how this logistic regression model performs on the cross-validation resamples.</p></li>
<li><p>Compute the metrics <code>roc_auc</code>, <code>sensitivity</code>, and <code>specificity</code>.</p></li>
</ul>
<div class="cell" data-layout-align="center" data-hash="VOTERS_cache/html/unnamed-chunk-17_aa29d70367c551fe54134fc8a897c8bd">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># all together now</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>vote_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(vote_train, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>vote_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(turnout16_2016 <span class="sc">~</span> ., <span class="at">data =</span> vote_train) <span class="sc">|&gt;</span>  </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_upsample</span>(turnout16_2016)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>glm_spec <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"glm"</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>vote_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(vote_recipe) <span class="sc">|&gt;</span> </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(glm_spec)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>glm_res <span class="ot">&lt;-</span> vote_wf <span class="sc">|&gt;</span> </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit_resamples</span>(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">resamples =</span> vote_folds, </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">metrics =</span> <span class="fu">metric_set</span>(roc_auc, sensitivity, specificity),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(glm_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 10
Columns: 5
$ splits       &lt;list&gt; [&lt;vfold_split[4817 x 536 x 5353 x 42]&gt;], [&lt;vfold_split[4â€¦
$ id           &lt;chr&gt; "Fold01", "Fold02", "Fold03", "Fold04", "Fold05", "Fold06â€¦
$ .metrics     &lt;list&gt; [&lt;tbl_df[3 x 4]&gt;], [&lt;tbl_df[3 x 4]&gt;], [&lt;tbl_df[3 x 4]&gt;],â€¦
$ .notes       &lt;list&gt; [&lt;tbl_df[0 x 3]&gt;], [&lt;tbl_df[0 x 3]&gt;], [&lt;tbl_df[0 x 3]&gt;],â€¦
$ .predictions &lt;list&gt; [&lt;tbl_df[536 x 6]&gt;], [&lt;tbl_df[536 x 6]&gt;], [&lt;tbl_df[536 xâ€¦</code></pre>
</div>
</div>
</section>
<section id="instructions-7" class="level3">
<h3 class="anchored" data-anchor-id="instructions-7">Instructions</h3>
<ul>
<li><p>Now fit the resamples <code>vote_folds</code> to the random forest model.</p></li>
<li><p>Compute the metrics <code>roc_auc</code>, <code>sensitivity</code>, and <code>specificity</code>.</p></li>
</ul>
<div class="cell" data-layout-align="center" data-hash="VOTERS_cache/html/unnamed-chunk-18_9bb6e84a200a1735e2a9fd195919f597">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rf model</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>()  <span class="sc">|&gt;</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>vote_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>()  <span class="sc">|&gt;</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(vote_recipe)  <span class="sc">|&gt;</span> </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(rf_spec)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>rf_res <span class="ot">&lt;-</span> vote_wf  <span class="sc">|&gt;</span> </span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit_resamples</span>(</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">resamples =</span> vote_folds,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">metrics =</span> <span class="fu">metric_set</span>(roc_auc, sensitivity, specificity),</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(rf_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 10
Columns: 5
$ splits       &lt;list&gt; [&lt;vfold_split[4817 x 536 x 5353 x 42]&gt;], [&lt;vfold_split[4â€¦
$ id           &lt;chr&gt; "Fold01", "Fold02", "Fold03", "Fold04", "Fold05", "Fold06â€¦
$ .metrics     &lt;list&gt; [&lt;tbl_df[3 x 4]&gt;], [&lt;tbl_df[3 x 4]&gt;], [&lt;tbl_df[3 x 4]&gt;],â€¦
$ .notes       &lt;list&gt; [&lt;tbl_df[0 x 3]&gt;], [&lt;tbl_df[0 x 3]&gt;], [&lt;tbl_df[0 x 3]&gt;],â€¦
$ .predictions &lt;list&gt; [&lt;tbl_df[536 x 6]&gt;], [&lt;tbl_df[536 x 6]&gt;], [&lt;tbl_df[536 xâ€¦</code></pre>
</div>
</div>
</section>
</section>
<section id="performance-metrics-from-resampling" class="level2">
<h2 class="anchored" data-anchor-id="performance-metrics-from-resampling">Performance metrics from resampling</h2>
<p>Now, letâ€™s evaluate these results from resampling.</p>
<section id="instructions-8" class="level3">
<h3 class="anchored" data-anchor-id="instructions-8">Instructions</h3>
<p>Use the function <code>collect_metrics()</code> to obtain the metrics we specified from the resampling results.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(glm_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 Ã— 6
  .metric     .estimator  mean     n std_err .config             
  &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 roc_auc     binary     0.718    10 0.0148  Preprocessor1_Model1
2 sensitivity binary     0.606    10 0.0201  Preprocessor1_Model1
3 specificity binary     0.702    10 0.00999 Preprocessor1_Model1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(rf_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 Ã— 6
  .metric     .estimator  mean     n  std_err .config             
  &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;               
1 roc_auc     binary     0.715    10 0.0222   Preprocessor1_Model1
2 sensitivity binary     0        10 0        Preprocessor1_Model1
3 specificity binary     1.00     10 0.000195 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
</section>
<section id="which-model-is-best" class="level2">
<h2 class="anchored" data-anchor-id="which-model-is-best">Which model is best?</h2>
<p>You have just spent most of this chapter exploring how to predict voter turnout based on survey responses. Of the two types of models you tried, which is the better choice? Which do you expect to perform better on new data? Logistic regression is a simpler model, but in this case, it performed better and you can expect it to do a better job predicting on new data.</p>
</section>
<section id="back-to-the-testing-data" class="level2">
<h2 class="anchored" data-anchor-id="back-to-the-testing-data">Back to the testing data</h2>
<p>When we used resampling to evaluate model performance with the training set, the logistic regression model performed better. Now, letâ€™s put this model to the test! ğŸ˜</p>
<p>Letâ€™s use the <code>last_fit()</code> function to fit to the entire training set one time and evaluate one time on the testing set, with everything weâ€™ve learned during this case study. Our model has not yet seen the testing data, so this last step is the best way to estimate how well the model will perform when predicting with new data.</p>
<section id="instructions-9" class="level3">
<h3 class="anchored" data-anchor-id="instructions-9">Instructions</h3>
<ul>
<li>Fit to the training set and evaluate on the testing set using <code>last_fit()</code>.</li>
</ul>
<div class="cell" data-layout-align="center" data-hash="VOTERS_cache/html/final_glm_fit_31b7877822f60d9e2bfee0becba95133">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine in workflow.</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Cache this chunk!</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>vote_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>()  <span class="sc">|&gt;</span> </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(vote_recipe)  <span class="sc">|&gt;</span> </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(glm_spec)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Final fit</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>vote_final <span class="ot">&lt;-</span> vote_wf <span class="sc">|&gt;</span> </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">last_fit</span>(vote_split)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>vote_final</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Resampling results
# Manual resampling 
# A tibble: 1 Ã— 6
  splits              id               .metrics .notes   .predictions .workflow 
  &lt;list&gt;              &lt;chr&gt;            &lt;list&gt;   &lt;list&gt;   &lt;list&gt;       &lt;list&gt;    
1 &lt;split [5353/1339]&gt; train/test split &lt;tibble&gt; &lt;tibble&gt; &lt;tibble&gt;     &lt;workflow&gt;</code></pre>
</div>
</div>
<ul>
<li>Create a confusion matrix for the results from the testing set.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Confusion matrix</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>vote_final <span class="sc">|&gt;</span>  </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect_predictions</span>()  <span class="sc">|&gt;</span>  </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">conf_mat</span>(<span class="at">truth =</span> turnout16_2016, <span class="at">estimate =</span> .pred_class) <span class="ot">-&gt;</span> CM</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>CM</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Truth
Prediction     Did not vote Voted
  Did not vote           35   407
  Voted                  18   879</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>CM <span class="sc">|&gt;</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 Ã— 3
   .metric              .estimator .estimate
   &lt;chr&gt;                &lt;chr&gt;          &lt;dbl&gt;
 1 accuracy             binary        0.683 
 2 kap                  binary        0.0761
 3 sens                 binary        0.660 
 4 spec                 binary        0.684 
 5 ppv                  binary        0.0792
 6 npv                  binary        0.980 
 7 mcc                  binary        0.143 
 8 j_index              binary        0.344 
 9 bal_accuracy         binary        0.672 
10 detection_prevalence binary        0.330 
11 precision            binary        0.0792
12 recall               binary        0.660 
13 f_meas               binary        0.141 </code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>